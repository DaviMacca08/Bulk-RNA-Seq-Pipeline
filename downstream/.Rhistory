geom_boxplot()
esoph |>
group_by(agegp) |>
mutate(f = (ncases/ncontrols) * 100) |>
ggplot(aes(x = f, y = after_stat(prop))) +
geom_boxplot()
esoph |>
group_by(agegp) |>
mutate(f = (ncases/ncontrols) * 100) |>
ggplot(aes(x = f, y = after_stat())) +
geom_boxplot()
age_f <- esoph %>%
group_by(agegp) %>%
summarise(f = sum(ncases)) %>%
ggplot(aes(x = f, y = agegp)) +
geom_boxplot()
age_f
---
editor_options:
markdown:
wrap: 72
install.packages("rmarkdown")
install.packages("knitr")
getwd()
ls
setwd("~/Bulk-RNA-Seq-Pipeline")
setwd("~/Bulk-RNA-Seq-Pipeline/downstream")
library(DESeq2)
library(ggplot2)
# ------------------------------------------
#            Building DESeq Object
# ------------------------------------------
# 01-Read counts.txt from featureCounts
counts <- read.table("counts.txt", sep = "\t", header = T, skip = 1)
counts <- counts[, -c(2:6)]
rownames(counts) <- counts$Geneid #Ensembl Gene ID
counts <- counts[, -1]
# 02-Set the correct samples names (siOGT --> siRNA, siNC --> Negative CTRL)
sample <- c("siOGT2-2", "siOGT2-1", "siOGT1-2", "siOGT1-1", "siNC-2", "siNC-1")
colnames(counts) <- sample
dim(counts)
counts <-counts[rowSums(counts) > 10, ]
dim(counts)
# 03-Build a colData with samples info and check the names and orders
colData <- data.frame(condition = factor(c("siOGT2", "siOGT2", "siOGT1", "siOGT1", "siNC", "siNC")))
rownames(colData) <- colnames(counts)
all(colnames(counts) %in% rownames(colData))
all(colnames(counts) == rownames(colData))
# 04-Build a DESeq Dataset object
dds <- DESeqDataSetFromMatrix(countData = counts,
colData = colData,
design = ~ condition)
# 05-Set the factor level and run DESeq function
dds$condition <- relevel(dds$condition, ref = "siNC")
dds <- DESeq(dds)
# 06-Variance stabilization using vst()
vsdata <- vst(dds, blind = FALSE)
pdf("01_PCA_VstData.pdf")
pca <- plotPCA(vsdata, intgroup = "condition")
pca + ggtitle("PCA - KGN cells, siOGT vs Control")
dev.off()
pdf("02_DispEsts_dds.pdf")
plotDispEsts(dds,  main = "Dispersion Estimates - KGN cells, siOGT vs Control")
dev.off()
# 07-Save output
message("DESeq2 object built with ", nrow(dds), " genes and ", ncol(dds), " samples")
saveRDS(dds, "dds.rds")
writeLines(rownames(vsdata), "background_genes.txt")
library(RColorBrewer)
library(pheatmap)
library(tidyverse)
library(DESeq2)
# ------------------------------------------
#            Exploratory Data Analysis
# ------------------------------------------
# 01-Load DESeq object
dds <- readRDS("dds.rds")
colData <- as.data.frame(colData(dds))["condition"]
message("Loaded DESeq2 object with ", nrow(dds), " genes and ", ncol(dds), " samples")
vsdata <- vst(dds, blind = FALSE)
# 02-Box-Plot vsdata
vsdata_df <- as.data.frame(assay(vsdata))
vsdata_df <- pivot_longer(cbind(gene = rownames(vsdata_df), vsdata_df),
-gene, names_to = "sample",
values_to = "expr")
pdf("03_BoxPlot_VstData.pdf")
ggplot(vsdata_df, aes(x = sample, y = expr, fill = sample)) +
geom_boxplot() +
theme_classic() +
scale_fill_manual(
values = c(
"siNC-1" = "#A6A6A6",
"siNC-2" = "#A6A6A6",
"siOGT1-1" = "#8DD3C7",
"siOGT1-2" = "#8DD3C7",
"siOGT2-1" = "#FB8072",
"siOGT2-2" = "#FB8072"
)) +
labs(
title = "Boxplot of VST counts - KGN cells",
y = "VST value",
x = "Sample"
) +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
dev.off()
# 03-Take 500 most variable genes from VstData
vars <- rowVars(assay(vsdata))
vars <- sort(vars, decreasing = TRUE)
vars <- vars[1:500]
topVars <- assay(vsdata)[names(vars),]
# 04-Calculate euclidean distances and cluster 500 most variable genes
dist <- dist(t(topVars), method = "euclidean")
dist_all <- dist(t(assay(vsdata)), method = "euclidean")
pdf("04_HierarchicalClustering_AllMethods.pdf")
plot(hclust(dist, method = "ward.D2"), main = "Hierarchical Clustering (Ward.D2) - Top 500 Most Variable Genes")
plot(hclust(dist, method = "complete"), main = "Hierarchical Clustering (Complete) - Top 500 Most Variable Genes")
plot(hclust(dist, method = "average"), main = "Hierarchical Clustering (Average) - Top 500 Most Variable Genes")
plot(hclust(dist_all, method = "ward.D2"), main = "Hierarchical Clustering (Ward.D2) - All Genes")
dev.off()
# 05-Heatmap with gene and samples dendograms of 500 most variables genes
colData$condition <- factor(colData$condition)
htmap_color <- colorRampPalette(c("dodgerblue4", "white", "darkorange2"))(100)
my_colors <- list(
condition = c(
siNC   = "#A6A6A6",
siOGT1 = "#8DD3C7",
siOGT2 = "#FB8072"
)
)
pheatmap(
topVars,
scale = "row",
color = htmap_color,
annotation_col = colData,
annotation_colors = my_colors,
cluster_rows = TRUE,
cluster_cols = TRUE,
clustering_method = "ward.D2",
show_rownames = FALSE,
fontsize_col = 12,
main = "Heatmap of top 500 most variable genes (VST)",
filename = "05_Heatmap_Top500.pdf",
width = 9,
height = 9
)
# 06-Heatmap sample-sample correlation
correlation_sample <- cor(assay(vsdata))
pheatmap(correlation_sample,
main="Sample-Sample Correlation",
cluster_rows = FALSE,
cluster_cols = FALSE,
filename = "06_Heatmap_SampleCor.pdf",
width = 7,
height = 7
)
# 07-Principal Components (PCA) of 500 most variables genes
pca_topVars <- prcomp(t(topVars))
names(pca_topVars)
summary(pca_topVars)
var_exp <- (pca_topVars$sdev^2) / sum(pca_topVars$sdev^2)
pdf("07_PrincipalComponent_Top500.pdf")
barplot(var_exp * 100,
names.arg = paste0("PC", seq_along(var_exp)),
las = 2,
ylab = "Variance explained (%)",
main = "PCA: Variance Explained by Principal Components",
col = "grey70",
border = NA
)
dev.off()
PC1_PC2 <- data.frame(PC1 = pca_topVars$x[,1],
PC2 = pca_topVars$x[,2],
condition = colData$condition)
pdf("08_PCA_Top500.pdf")
ggplot(PC1_PC2, aes(x = PC1, y = PC2, color = condition)) +
geom_point(size = 4) +
xlab(paste0("PC1 (", round(var_exp[1]*100,1), "%)")) +
ylab(paste0("PC2 (", round(var_exp[2]*100,1), "%)")) +
theme_bw() +
ggtitle("PCA of top 500 most variable genes")
dev.off()
library(DESeq2)
library(AnnotationDbi)
library(EnhancedVolcano)
library(pheatmap)
library(org.Hs.eg.db)
library(tidyverse)
# ------------------------------------------------
#            Differentially Expressed Genes (DEGs)
# ------------------------------------------------
dds <- readRDS("dds.rds")
vsdata <- vst(dds, blind = FALSE)
colData <- as.data.frame(colData(dds))["condition"]
message("Loaded DESeq2 object with ", nrow(dds), " genes and ", ncol(dds), " samples")
# 01-Get the normalized results form DESeq object and get Symbol Gene
DEG_siOGT1 <- results(dds, contrast = c("condition", "siOGT1", "siNC"), alpha = 0.05)
DEG_siOGT2 <- results(dds, contrast = c("condition", "siOGT2", "siNC"), alpha = 0.05)
summary(DEG_siOGT1)
summary(DEG_siOGT2)
siOGT1_res <- as.data.frame(DEG_siOGT1)
siOGT1_res <- siOGT1_res[!is.na(siOGT1_res$padj),]
siOGT1_res$symbol <- mapIds(
org.Hs.eg.db,
keys = rownames(siOGT1_res),
keytype = "ENSEMBL",
column = "SYMBOL",
multiVals = "first"
)
siOGT2_res <- as.data.frame(DEG_siOGT2)
siOGT2_res <- siOGT2_res[!is.na(siOGT2_res$padj),]
siOGT2_res$symbol <- mapIds(
org.Hs.eg.db,
keys = rownames(siOGT2_res),
keytype = "ENSEMBL",
column = "SYMBOL",
multiVals = "first"
)
all(rownames(vsdata) %in% rownames(dds))
# 02-MA Plot
pdf("09_MA_siOGT.pdf")
plotMA(
DEG_siOGT1,
ylim = c(-7, 7),
alpha = 0.05,
main = "MA plot – siOGT1 vs Control"
)
abline(h = c(-1, 1), col = "grey50", lty = 2)
plotMA(DEG_siOGT2,
ylim = c(-7,7),
alpha = 0.05,
main = "MA plot – siOGT2 vs Control"
)
abline(h = c(-1,1), col="grey50", lty = 2)
dev.off()
# 03-VolcanoPlot_vs01
pdf("10_EnhancedVolcano_siOGT.pdf")
EnhancedVolcano(
siOGT1_res,
lab = siOGT1_res$symbol,
x = "log2FoldChange",
y = "padj",
title = "Volcano plot – siOGT1 vs siNC",
subtitle = "All genes tested (DESeq2 results)"
)
EnhancedVolcano(
siOGT2_res,
lab = siOGT2_res$symbol,
x = "log2FoldChange",
y = "padj",
title = "Volcano plot – siOGT2 vs siNC",
subtitle = "All genes tested (DESeq2 results)"
)
dev.off()
# 03-Significant genes
significant1 <- siOGT1_res
significant1$threshold <- abs(siOGT1_res$log2FoldChange) > 0.5 & significant1$padj < 0.05
significant2 <- siOGT2_res
significant2$threshold <- abs(significant2$log2FoldChange) > 0.5 & significant2$padj < 0.05
# 04-VolcanoPlot_vs02 for significant genes
v1 <- ggplot(significant1, aes(x = log2FoldChange,
y = -log10(padj),
colour = threshold)) +
geom_point(alpha = 0.6, size = 1.6, na.rm = TRUE) +
scale_color_manual(values = c("FALSE" = "grey70", "TRUE" = "firebrick")) +
geom_vline(xintercept = c(-0.5, 0.5), linetype = "dashed", colour = "black") +
geom_hline(yintercept = -log10(0.05), linetype = "dashed", colour = "black") +
labs(
title = "Volcano plot – siOGT1 vs siNC",
subtitle = "All genes tested; DEGs highlighted (adjusted p-value < 0.05, |log2FC| > 0.5)",
x = "log2 fold change",
y = "-log10 adjusted p-value",
colour = "Significant"
) +
coord_cartesian() +
theme_classic() +
theme(
axis.text  = element_text(size = 12),
axis.title = element_text(size = 14, face = "bold"),
legend.title = element_text(size = 12),
legend.text  = element_text(size = 11)
)
v2 <- ggplot(significant2, aes(x = log2FoldChange,
y = -log10(padj),
colour = threshold)) +
geom_point(alpha = 0.6, size = 1.6, na.rm = TRUE) +
scale_color_manual(values = c("FALSE" = "grey70", "TRUE" = "firebrick")) +
geom_vline(xintercept = c(-0.5, 0.5), linetype = "dashed", colour = "black") +
geom_hline(yintercept = -log10(0.05), linetype = "dashed", colour = "black") +
labs(
title = "Volcano plot – siOGT2 vs siNC",
subtitle = "All genes tested; DEGs highlighted (adjusted p-value < 0.05, |log2FC| > 0.5)",
x = "log2 fold change",
y = "-log10 adjusted p-value",
colour = "Significant"
) +
coord_cartesian() +
theme_classic() +
theme(
axis.text  = element_text(size = 12),
axis.title = element_text(size = 14, face = "bold"),
legend.title = element_text(size = 12),
legend.text  = element_text(size = 11)
)
pdf("11_VolcanoPlot_Highlighted_DEG.pdf")
print(v1)
print(v2)
dev.off()
# 05-Find DEGs
# siOGT1
DEG_siOGT1 <- filter(significant1, threshold == TRUE)
dim(DEG_siOGT1)
DEG_siOGT1_up <- DEG_siOGT1 |>
filter(log2FoldChange > 0)
DEG_siOGT1_up <- rownames(DEG_siOGT1_up)
DEG_siOGT1_down <- DEG_siOGT1 |>
filter(log2FoldChange < 0)
DEG_siOGT1_down <- rownames(DEG_siOGT1_down)
# siOGT2
DEG_siOGT2 <- filter(significant2, threshold == TRUE, )
dim(DEG_siOGT2)
DEG_siOGT2_up <- DEG_siOGT2 |>
filter(log2FoldChange > 0)
DEG_siOGT2_up <- rownames(DEG_siOGT2_up)
DEG_siOGT2_down <- DEG_siOGT2 |>
filter(log2FoldChange < 0)
DEG_siOGT2_down <- rownames(DEG_siOGT2_down)
# Common DEGs
DEG_common <- intersect(rownames(DEG_siOGT1), rownames(DEG_siOGT2))
DEG_common_up <- intersect(DEG_siOGT1_up, DEG_siOGT2_up)
DEG_common_down <- intersect(DEG_siOGT1_down, DEG_siOGT2_down)
cat(
"siOGT1-upregulated: ", length(DEG_siOGT1_up), "\n",
"siOGT1-downregulated: ", length(DEG_siOGT1_down), "\n",
"Total DEG for siOGT1: ", length(DEG_siOGT1_up) + length(DEG_siOGT1_down), "\n",
"\n",
"siOGT2-upregulated: ", length(DEG_siOGT2_up), "\n",
"siOGT2-downregulated: ", length(DEG_siOGT2_down), "\n",
"Total DEG for siOGT2: ", length(DEG_siOGT2_up) + length(DEG_siOGT2_down), "\n",
"\n",
"DEG common upregulated: ", length(DEG_common_up), "\n",
"DEG common downregulated: ", length(DEG_common_down), "\n",
"Total common DEG: ", length(DEG_common_up) + length(DEG_common_down)
)
# 06-Heatmap of DEGs
DEG_matrix1 <- assay(vsdata)[rownames(DEG_siOGT1),]
DEG_matrix2 <- assay(vsdata)[rownames(DEG_siOGT2), ]
DEG_common_matrix <- assay(vsdata)[DEG_common,]
# siOGT1
pdf("12_Heatmaps_DEGs.pdf", width = 10, height = 10)
h1 <- pheatmap(DEG_matrix1,
scale="row",
color = colorRampPalette(c("blue", "white", "red"))(100),
annotation_col = colData,
show_rownames = FALSE,
main = "siOGT1: DEGs padj < 0.05 & |log2FC| > 0.5"
)
# siOGT2
h2 <- pheatmap(DEG_matrix2, scale="row",
color = colorRampPalette(c("blue", "white", "red"))(100),
annotation_col = colData,
show_rownames = FALSE,
main = "siOGT2: DEGs padj < 0.05 & |log2FC| > 0.5"
)
# Common DEGs
pheatmap(DEG_common_matrix, scale="row",
color = colorRampPalette(c("blue", "white", "red"))(100),
annotation_col = colData,
show_rownames = FALSE,
main = "Common Genes for siOGT1 and siOGT2: DEGs padj < 0.05 & |log2FC| > 0.5"
)
dev.off()
# 07-Save DEG common
writeLines(DEG_common_up, "DEG_common_up.txt")
writeLines(DEG_common_down, "DEG_common_down.txt")
library(org.Hs.eg.db)
library(clusterProfiler)
library(ReactomePA)
library(ggplot2)
# ------------------------------------------------
#            Gene Onthology (GO) on commong Genes
# ------------------------------------------------
# 01-Load list of common DEGs
Gene_ID_bg <- readLines("background_genes.txt")
DEG_common_up <- readLines("DEG_common_up.txt")
DEG_common_down <- readLines("DEG_common_down.txt")
# 02-Search GO terms
# up-regulated genes
GO_up <- enrichGO(gene = DEG_common_up,
OrgDb = "org.Hs.eg.db",
keyType = "ENSEMBL",
ont = "BP")
GO_up <- as.data.frame(GO_up)
dim(GO_up)
message("No GO terms for up-regulated genes")
# down-regulated genes
GO_down<- enrichGO(gene = DEG_common_down,
OrgDb = "org.Hs.eg.db",
keyType = "ENSEMBL",
ont = "BP")
GO_down<- as.data.frame(GO_down)
dim(GO_down)
message("Found ", nrow(GO_down), " terms for down-regulated genes")
GO_top_down <- GO_down |>
dplyr::arrange(p.adjust) |>
dplyr::slice_head(n = 20)
# barplot of top 20 GO terms
go <- ggplot(GO_top_down, aes(
x = reorder(Description, Count),
y = Count,
fill = -log10(p.adjust)))+
geom_col() +
coord_flip() +
scale_fill_viridis_c(name = "-log10(adj p-value)") +
theme_classic() +
labs(
x = NULL,
y = "Gene count",
title = "GO enrichment – Biological Process"
)
ggsave("13_GO_20BP.pdf", plot = go, width = 8, height = 6)
# ------------------------------------------------
#            Pathway Enrichment
# ------------------------------------------------
# 03-Pathway Enrichment using KEGG and Reactome
# Setup
DEG_common_down_entrezID <- mapIds(org.Hs.eg.db,
keys = DEG_common_down,
keytype = "ENSEMBL",
column = "ENTREZID",
multiVals = "first"
)
DEG_common_down_entrezID <- na.omit(DEG_common_down_entrezID)
background <- mapIds(org.Hs.eg.db,
keys = Gene_ID_bg,
keytype = "ENSEMBL",
column = "ENTREZID",
multiVals = "first")
# KEGG database
kegg <- enrichKEGG(gene = DEG_common_down_entrezID,
organism = "hsa",
universe = background,
pvalueCutoff = 0.05,
qvalueCutoff = 0.1
)
kegg_df <- as.data.frame(kegg)
# Reactome databse
reactome <- enrichPathway(gene = DEG_common_down_entrezID,
organism = "human",
universe = background,
pvalueCutoff = 0.05,
qvalueCutoff = 0.1)
reactome_df <- as.data.frame(reactome)
# Visualization of pathway enrichment
# KEGG
pdf("14_PathwayEnrichment_KEGG.pdf", width = 10, height = 10)
dotplot(kegg,
showCategory = 15,
title = "KEGG Pathway Enrichment – Top 15 pathways (Down-regulated DEGs)"
)
kegg_readable <- setReadable(kegg, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")
cnetplot(kegg,
showCategory = 8,
node_label = "category"
) +
ggtitle("KEGG Pathway Enrichment: Top 8 Pathways") +
theme(plot.title = element_text(hjust = 0.5))
kegg_df<- kegg_df|>
dplyr::arrange(p.adjust) |>
dplyr::slice_head(n = 20)
ggplot(kegg_df, aes(
x = reorder(Description, Count),
y = Count,
fill = -log10(p.adjust)))+
geom_col() +
coord_flip() +
scale_fill_viridis_c(name = "-log10(adj p-value)") +
theme_classic() +
labs(
x = NULL,
y = "Gene count",
title = "KEGG  Pathway Enrichment – Downregulated DEGs"
)
dev.off()
# Reactome
pdf("15_PathwayEnrichment_Reactome.pdf", width = 10, height = 10)
dotplot(reactome,
showCategory = 20,
title  = "Reactome Pathway Enrichment – Top 20 pathways (Down-regulated DEGs)"
)
reactome_readable <- setReadable(reactome, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")
cnetplot(reactome_readable,
showCategory = 8,
node_label = "category") +
ggtitle("Reactome Pathway Enrichment: Top 8 Pathways") +
theme(plot.title = element_text(hjust = 0.5))
reactome_df <- reactome_df |>
dplyr::arrange(p.adjust) |>
dplyr::slice_head(n = 20)
ggplot(reactome_df, aes(
x = reorder(Description, Count),
y = Count,
fill = -log10(p.adjust)))+
geom_col() +
coord_flip() +
scale_fill_viridis_c(name = "-log10(adj p-value)") +
theme_classic() +
labs(
x = NULL,
y = "Gene count",
title = "Reactome Pathway Enrichment – Downregulated DEGs"
)
dev.off()
